# Line Detection Parameter Tuner

地図の図郭（外枠）検出のためのパラメータ調整ツールです。Webインターフェースを通じて直線検出パラメータをリアルタイムで調整し、結果を視覚的に確認できます。

## 概要

このツールは、地図画像から図郭を構成する直線を検出する`detect_lines`関数のパラメータを調整するためのWebアプリケーションです。検出された直線は類似性に基づいてグループ化され、グループごとに異なる色で表示されます。

### 主な機能

- **リアルタイムパラメータ調整**: スライダーを使用した直感的なパラメータ調整
- **視覚的結果確認**: 元画像に検出された直線を重ねて表示
- **直線グループ化**: 類似した直線を自動的にグループ化し、色分け表示
- **統計情報表示**: 検出された直線数とグループ数の表示

## システム要件

- Python 3.7以上
- 必要なライブラリ（requirements.txtに記載）

## インストール

1. リポジトリをクローンまたはダウンロード
```bash
git clone <repository-url>
cd gaihozu-georecognition
```

2. 依存関係をインストール
```bash
pip install -r requirements.txt
```

## 使用方法

### 1. サーバーの起動

```bash
python app.py
```

サーバーが起動すると、以下のメッセージが表示されます：
```
* Running on http://127.0.0.1:5001
```

### 2. Webインターフェースへのアクセス

ブラウザで `http://127.0.0.1:5001` にアクセスします。

### 3. パラメータ調整と処理実行

1. **画像選択**: ドロップダウンメニューからサンプル画像を選択
2. **パラメータ調整**: 各スライダーを使用してパラメータを調整
3. **処理実行**: 「処理実行」ボタンをクリック
4. **結果確認**: 検出された直線が色分けされて表示されます

## パラメータ説明

### Binary Threshold (二値画像変換の閾値)
- **範囲**: 1-255
- **デフォルト**: 100
- **説明**: グレースケール画像を二値画像に変換する際の閾値。値が小さいほど多くの領域が白になります。

### Erode Kernel (erodeのkernelの大きさ)
- **範囲**: 1-10
- **デフォルト**: 3
- **説明**: モルフォロジー演算（erode）で使用するカーネルのサイズ。細い線の除去に影響します。

### Erode Iteration (erodeの実行回数)
- **範囲**: 1-10
- **デフォルト**: 2
- **説明**: erode処理を繰り返す回数。多いほど細い線がより除去されます。

### Line Accumulation (直線認識の閾値)
- **範囲**: 1000-50000
- **デフォルト**: 10000
- **説明**: Hough変換で直線として認識するために必要な投票数。値が大きいほど長い直線のみが検出されます。

### Rho Precision (ρの精度)
- **範囲**: 1-10
- **デフォルト**: 2
- **説明**: Hough変換における距離パラメータの精度（ピクセル単位）。

### Theta Precision (θの精度)
- **範囲**: 1-180
- **デフォルト**: 2
- **説明**: Hough変換における角度パラメータの精度。値はπ/値で計算されます。

## 直線グループ化機能

検出された直線は以下の基準で自動的にグループ化されます：

- **距離の類似性**: rho（距離）の差が500ピクセル以内
- **角度の類似性**: theta（角度）の差がπ/18ラジアン以内

類似した直線は同じグループに分類され、グループごとに異なる色で表示されます。

### 使用される色

1. 赤 (255, 0, 0)
2. 緑 (0, 255, 0)
3. 青 (0, 0, 255)
4. 黄 (0, 255, 255)
5. マゼンタ (255, 0, 255)
6. シアン (255, 255, 0)
7. 紫 (128, 0, 128)
8. オレンジ (255, 165, 0)

グループ数が8を超える場合は、色が循環して使用されます。

## プロジェクト構成

```
gaihozu-georecognition/
├── app.py                 # Flaskサーバーのメインファイル
├── index.html            # Webインターフェース
├── line_detector.py      # 直線検出関数
├── corner_getter.py      # 角点検出関数（参考実装）
├── requirements.txt      # 依存関係
├── targets/             # サンプル画像ディレクトリ
│   ├── *.jpg           # 地図画像ファイル
└── README.md           # このファイル
```

### 主要ファイルの説明

#### app.py
- Flaskベースのバックエンドサーバー
- 画像処理API（`/api/process`）
- 画像リスト取得API（`/api/images`）
- 直線グループ化機能

#### index.html
- レスポンシブWebインターフェース
- パラメータ調整用スライダー
- 結果表示機能
- リアルタイム値更新

#### line_detector.py
- `detect_lines`関数の実装
- OpenCVを使用したHough変換による直線検出

## APIエンドポイント

### GET /api/images
サンプル画像のリストを取得

**レスポンス例:**
```json
{
  "images": ["image1.jpg", "image2.jpg", ...]
}
```

### POST /api/process
画像処理を実行

**リクエスト例:**
```json
{
  "image_name": "sample.jpg",
  "parameters": {
    "binary_threshold": 100,
    "erode_kernel": 3,
    "erode_iteration": 2,
    "line_accumulation": 10000,
    "rho_precision": 2,
    "theta_precision": 0.034906585
  }
}
```

**レスポンス例:**
```json
{
  "success": true,
  "image": "data:image/jpeg;base64,/9j/4AAQ...",
  "lines_count": 15,
  "groups_count": 4
}
```

## 開発・カスタマイズ

### 新しい画像の追加
`targets/`ディレクトリに画像ファイル（.jpg, .jpeg, .png）を追加するだけで、自動的にドロップダウンメニューに表示されます。

### パラメータ範囲の変更
`index.html`のスライダー設定を変更することで、パラメータの範囲を調整できます。

### グループ化アルゴリズムの調整
`app.py`の`group_similar_lines`関数内の閾値（500ピクセル、π/18ラジアン）を変更することで、グループ化の感度を調整できます。

## トラブルシューティング

### ポート5001が使用中の場合
`app.py`の最後の行でポート番号を変更してください：
```python
app.run(debug=True, host='0.0.0.0', port=5002)  # 5002に変更
```

### 画像が表示されない場合
- サンプル画像が`targets/`ディレクトリに存在することを確認
- 画像ファイルの形式が対応形式（.jpg, .jpeg, .png）であることを確認

### 処理が遅い場合
- `line_accumulation`の値を大きくして検出する直線数を減らす
- 画像サイズが大きい場合は、事前にリサイズを検討

## ライセンス

このプロジェクトのライセンスについては、LICENSEファイルを参照してください。
