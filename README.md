# Line Detection Parameter Tuner

地図の図郭（外枠）検出のためのパラメータ調整ツールです。Webインターフェースを通じて直線検出パラメータをリアルタイムで調整し、結果を視覚的に確認できます。

## 概要

このツールは、地図画像から図郭を構成する直線を検出する`detect_lines`関数のパラメータを調整するためのWebアプリケーションです。検出された直線は類似性に基づいてグループ化され、グループごとに異なる色で表示されます。

### 主な機能

- **リアルタイムパラメータ調整**: スライダーを使用した直感的なパラメータ調整
- **視覚的結果確認**: 元画像に検出された直線を重ねて表示
- **直線グループ化**: 類似した直線を自動的にグループ化し、色分け表示
- **オフセット機能**: 検出された図郭線を内側にオフセットさせることで、地図の真の4隅を特定。図郭と真の4隅の間にあるマージンを調整可能
- **統計情報表示**: 検出された直線数とグループ数の表示
- **プロファイル管理**: パラメータ設定の保存・読み込み・削除機能

## システム要件

- Python 3.7以上
- 必要なライブラリ（requirements.txtに記載）

## インストール

1. リポジトリをクローンまたはダウンロード
```bash
git clone <repository-url>
cd gaihozu-georecognition
```

2. 依存関係をインストール
```bash
pip install -r requirements.txt
```

## 使用方法

### 1. サーバーの起動

```bash
python app.py
```

サーバーが起動すると、以下のメッセージが表示されます：
```
* Running on http://127.0.0.1:5001
```

### 2. Webインターフェースへのアクセス

ブラウザで `http://127.0.0.1:5001` にアクセスします。

### 3. パラメータ調整と処理実行

1. **画像選択**: ドロップダウンメニューからサンプル画像を選択
2. **パラメータ調整**: 各スライダーを使用してパラメータを調整
3. **処理実行**: 「処理実行」ボタンをクリック
4. **結果確認**: 検出された直線が色分けされて表示されます

## パラメータ説明

### Binary Threshold (二値画像変換の閾値)
- **範囲**: 1-255
- **デフォルト**: 100
- **説明**: グレースケール画像を二値画像に変換する際の閾値。値が小さいほど多くの領域が白になります。

### Erode Kernel (erodeのkernelの大きさ)
- **範囲**: 1-10
- **デフォルト**: 3
- **説明**: モルフォロジー演算（erode）で使用するカーネルのサイズ。細い線の除去に影響します。

### Erode Iteration (erodeの実行回数)
- **範囲**: 1-10
- **デフォルト**: 2
- **説明**: erode処理を繰り返す回数。多いほど細い線がより除去されます。

### Line Accumulation (直線認識の閾値)
- **範囲**: 1000-50000
- **デフォルト**: 10000
- **説明**: Hough変換で直線として認識するために必要な投票数。値が大きいほど長い直線のみが検出されます。

### Rho Precision (ρの精度)
- **範囲**: 1-10
- **デフォルト**: 2
- **説明**: Hough変換における距離パラメータの精度（ピクセル単位）。

### Theta Precision (θの精度)
- **範囲**: 1-180
- **デフォルト**: 2
- **説明**: Hough変換における角度パラメータの精度。値はπ/値で計算されます。

### オフセット（0 - 100%）
- **範囲**: 0-100
- **デフォルト**: 0
- **説明**: グループ化された線を内側にオフセットさせる割合。地図の図郭と真の4隅の間にあるマージンを調整するために使用します。線の向き（縦/横）を自動判定し、適切な方向にオフセットします。

## 直線グループ化機能

検出された直線は以下の基準で自動的にグループ化されます：

- **距離の類似性**: rho（距離）の差が500ピクセル以内
- **角度の類似性**: theta（角度）の差がπ/18ラジアン以内

類似した直線は同じグループに分類され、グループごとに異なる色で表示されます。

### 使用される色

1. 赤 (255, 0, 0)
2. 緑 (0, 255, 0)
3. 青 (0, 0, 255)
4. 黄 (0, 255, 255)
5. マゼンタ (255, 0, 255)
6. シアン (255, 255, 0)
7. 紫 (128, 0, 128)
8. オレンジ (255, 165, 0)

グループ数が8を超える場合は、色が循環して使用されます。

## オフセット機能について

地図の図郭（外枠）を検出する際、検出される線と地図の真の4隅の間にはマージンが存在することがあります。このマージンは地図によって異なるため、オフセット機能を使用して調整することができます。

オフセット機能は以下のように動作します：

1. **線の向き判定**: 検出された線の角度（theta）から、その線が縦向きか横向きかを自動判定
   - theta < π/4 または theta > 3π/4 の場合：縦向き
   - それ以外の場合：横向き

2. **オフセット方向の決定**: 線の向きと画像の中心からの位置に基づいて、内側へのオフセット方向を決定
   - 縦線：画像の中心より右側の線は左に、左側の線は右にオフセット
   - 横線：画像の中心より下側の線は上に、上側の線は下にオフセット

3. **オフセット量の計算**: 画像サイズに対する相対的な割合（0-100%）で指定
   - 最大オフセット量は画像の短辺の30%まで
   - 実際のオフセット量 = 最大オフセット量 × (設定値 / 100)

これにより、図郭の検出精度を向上させ、地図の真の4隅をより正確に特定することができます。特に、古い地図や印刷品質の影響で図郭線が太くなっている場合に有効です。

## プロファイル管理機能

パラメータ設定を保存・管理する機能により、効率的な作業が可能です。

### 機能概要

- **パラメータ保存**: 現在の7つのパラメータ設定を名前付きで保存
- **プロファイル一覧**: 保存されたプロファイルをリスト表示
- **設定復元**: 保存されたプロファイルをクリックして設定を復元
- **プロファイル削除**: 不要なプロファイルをチェックボックスで選択して削除
- **現在のプロファイル表示**: 適用中のプロファイル名を表示

### 使用方法

#### プロファイルの保存
1. パラメータスライダーで最適な設定を調整
2. 「現在の設定を保存」ボタンをクリック
3. プロンプトでプロファイル名を入力（例：「高精度設定」「古地図用」など）
4. プロファイルがリストに追加され、保存日時と共に表示

#### プロファイルの適用
1. プロファイルリストから適用したいプロファイルをクリック
2. 全パラメータが自動的に復元される
3. 「現在のプロファイル」表示が更新される
4. 選択されたプロファイルがハイライト表示される

#### プロファイルの削除
1. 削除したいプロファイルのチェックボックスを選択（複数選択可能）
2. 「選択したプロファイルを削除」ボタンをクリック
3. 確認ダイアログで削除対象を確認
4. 「OK」で削除実行

### データ保存

- **保存場所**: ブラウザのローカルストレージ
- **保存内容**: プロファイル名、保存日時、7つのパラメータ値
- **永続性**: ブラウザデータを削除するまで保持
- **共有**: 同一ブラウザ・同一ドメインでのみ利用可能

### プロファイルデータ構造

```json
{
  "profiles": [
    {
      "id": "1640995200000",
      "name": "高精度設定",
      "timestamp": "2024/1/1 12:00:00",
      "parameters": {
        "binary_threshold": 120,
        "erode_kernel": 2,
        "erode_iteration": 1,
        "line_accumulation": 15000,
        "rho_precision": 1,
        "theta_precision": 1.5708,
        "line_offset": 10
      }
    }
  ]
}
```

### 注意事項

- パラメータを手動で変更すると、現在のプロファイル名が「デフォルト」にリセットされます
- ブラウザのプライベートモードでは、セッション終了時にデータが削除されます
- ブラウザの設定でローカルストレージが無効化されている場合、機能が利用できません

## プロジェクト構成

```
gaihozu-georecognition/
├── app.py                 # Flaskサーバーのメインファイル
├── index.html            # Webインターフェース
├── line_detector.py      # 直線検出関数
├── corner_getter.py      # 角点検出関数（参考実装）
├── requirements.txt      # 依存関係
├── targets/             # サンプル画像ディレクトリ
│   ├── *.jpg           # 地図画像ファイル
└── README.md           # このファイル
```

### 主要ファイルの説明

#### app.py
- Flaskベースのバックエンドサーバー
- 画像処理API（`/api/process`）
- 画像リスト取得API（`/api/images`）
- 直線グループ化機能

#### index.html
- レスポンシブWebインターフェース
- パラメータ調整用スライダー
- 結果表示機能
- リアルタイム値更新

#### line_detector.py
- `detect_lines`関数の実装
- OpenCVを使用したHough変換による直線検出

## APIエンドポイント

### GET /api/images
サンプル画像のリストを取得

**レスポンス例:**
```json
{
  "images": ["image1.jpg", "image2.jpg", ...]
}
```

### POST /api/process
画像処理を実行

**リクエスト例:**
```json
{
  "image_name": "sample.jpg",
  "parameters": {
    "binary_threshold": 100,
    "erode_kernel": 3,
    "erode_iteration": 2,
    "line_accumulation": 10000,
    "rho_precision": 2,
    "theta_precision": 0.034906585
  }
}
```

**レスポンス例:**
```json
{
  "success": true,
  "image": "data:image/jpeg;base64,/9j/4AAQ...",
  "lines_count": 15,
  "groups_count": 4
}
```

## 開発・カスタマイズ

### 新しい画像の追加
`targets/`ディレクトリに画像ファイル（.jpg, .jpeg, .png）を追加するだけで、自動的にドロップダウンメニューに表示されます。

### パラメータ範囲の変更
`index.html`のスライダー設定を変更することで、パラメータの範囲を調整できます。

### グループ化アルゴリズムの調整
`app.py`の`group_similar_lines`関数内の閾値（500ピクセル、π/18ラジアン）を変更することで、グループ化の感度を調整できます。

## トラブルシューティング

### ポート5001が使用中の場合
`app.py`の最後の行でポート番号を変更してください：
```python
app.run(debug=True, host='0.0.0.0', port=5002)  # 5002に変更
```

### 画像が表示されない場合
- サンプル画像が`targets/`ディレクトリに存在することを確認
- 画像ファイルの形式が対応形式（.jpg, .jpeg, .png）であることを確認

### 処理が遅い場合
- `line_accumulation`の値を大きくして検出する直線数を減らす
- 画像サイズが大きい場合は、事前にリサイズを検討

## ライセンス

このプロジェクトのライセンスについては、LICENSEファイルを参照してください。
