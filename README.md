# gaihozu-georecognition

地図の図郭（外枠）検出ツールです。Webインターフェースを通じて直線検出パラメータをリアルタイムで調整し、結果を視覚的に確認できます。

## 主な機能

- **リアルタイムパラメータ調整**: スライダーを使用したパラメータ調整
- **視覚的結果確認**: 元画像と検出された図郭を重ねて表示
- **オフセット機能**: 検出された図郭線を内側にオフセットさせることで、地図の真の4隅を特定
- **プロファイル管理**: パラメータ設定の保存・読み込み・削除機能
- **バッチ処理機能**: すべての画像の交点を一括計算してCSV出力
- **CSVプレビュー**: 処理結果をブラウザ上で確認可能
- **ハンディモード**: 手動で制御点を設定し、地図の4隅座標を正確に指定

## システム要件

- Python 3.7以上
- 必要なライブラリ（requirements.txtに記載）

## インストール

操作はシェル（PowerShell 等）で行ってください。

1. リポジトリをクローンまたはダウンロード
```bash
git clone https://github.com/kamataryo/gaihozu-georecognition
cd gaihozu-georecognition
```

2. 依存関係をインストール
```bash
pip install -r requirements.txt
```

## 使用方法

### 1. サーバーの起動

#### 基本的な起動（デフォルトのtargetsディレクトリを使用。サンプル画像で機能を試すことができます）

```bash
python app.py
```

#### 任意のディレクトリを指定して起動

```bash
python app.py /path/to/your/images_dir
```

サーバーが起動すると、以下のメッセージが表示されます：
```
* Running on http://127.0.0.1:5001
```

### 2. Webインターフェースへのアクセス

#### メインツール（パラメータ調整）
ブラウザで `http://127.0.0.1:5001` にアクセスします。

#### ハンディモード（制御点設定）
ブラウザで `http://127.0.0.1:5001/handy.html` にアクセスします。

### 3. パラメータ調整と処理実行

1. **画像選択**: ドロップダウンメニューから指定された画像を選択
2. **パラメータ調整**: 各スライダーを使用してパラメータを調整
3. **処理実行**: 「処理実行」ボタンをクリック
4. **結果確認**: 検出された直線が表示されます

## 基本的なパラメータ

- **Binary Threshold**: グレースケール画像を二値画像に変換する際の閾値（1-255、デフォルト: 100）
- **Erode Kernel**: モルフォロジー演算で使用するカーネルのサイズ（1-10、デフォルト: 3）
- **Erode Iteration**: erode処理を繰り返す回数（1-10、デフォルト: 2）
- **Line Accumulation**: 直線として認識するために必要な投票数（1000-50000、デフォルト: 10000）
- **Rho Precision**: 距離パラメータの精度（1-10、デフォルト: 2）
- **Theta Precision**: 角度パラメータの精度（1-180、デフォルト: 2）
- **オフセット**: グループ化された線を内側にオフセットさせる割合（0-100%、デフォルト: 0）

詳細なパラメータ説明や技術仕様については、[SPEC.md](SPEC.md)を参照してください。

## プロファイル管理

パラメータ設定を保存・管理できます：

1. **保存**: 「現在の設定を保存」ボタンでプロファイル名を入力して保存
2. **適用**: プロファイルリストから適用したいプロファイルをクリック
3. **削除**: チェックボックスで選択して「選択したプロファイルを削除」ボタンをクリック

## ハンディモード（制御点設定）

手動で制御点を設定し、地図の4隅の座標を正確に指定できる機能です。

### 使用方法

1. **ハンディモードへのアクセス**: `http://127.0.0.1:5001/handy.html`
2. **画像選択**: 左ペインの画像一覧から対象画像をクリック
3. **制御点の設定**:
   - 画像上をクリック：制御点を追加（最大4点まで）
   - 制御点をドラッグ：制御点を移動
   - 制御点を右クリック：制御点を削除
4. **保存**: 「制御点を保存」ボタンで座標を保存
5. **一括ダウンロード**: 「制御点を全てダウンロード」ボタンで全画像の制御点をCSV形式でダウンロード

### 画像状態の表示

- ✅: 制御点保存済み
- ❓: 画像が変更されている（制御点の再設定が必要）
- ⚪: 制御点未設定
- ❌: エラー

### CSV出力形式

制御点は左上→右上→右下→左下の順で自動的に並び替えられ、以下の形式で出力されます：

```csv
ファイル名,left_top_x,left_top_y,right_top_x,right_top_y,right_bottom_x,right_bottom_y,left_bottom_x,left_bottom_y
sample1.jpg,100,50,800,60,790,600,110,590
```

### データ保存形式

制御点データは各画像と同じディレクトリに `.controls.geojson` ファイルとして保存されます：

```json
{
  "hash": "画像のMD5ハッシュ値",
  "control_points": [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]
}
```

## バッチ処理

複数の画像を一括処理してCSVファイルを出力できます：

1. パラメータを調整
2. 「すべての画像の交点を計算」ボタンをクリック
3. 処理完了後、CSVファイルをダウンロードまたはプレビューで確認

## トラブルシューティング

### ポート5001が使用中の場合
`app.py`の最後の行でポート番号を変更してください：
```python
app.run(debug=True, host='0.0.0.0', port=5002)  # 5002に変更
```

### 画像が表示されない場合
- サンプル画像が`targets/`ディレクトリに存在することを確認
- 画像ファイルの形式が対応形式（.jpg, .jpeg, .png）であることを確認

## ライセンス

このプロジェクトのライセンスについては、LICENSEファイルを参照してください。
